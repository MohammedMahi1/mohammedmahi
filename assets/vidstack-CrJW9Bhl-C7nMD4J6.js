import{t as p,C as n,q as d,p as k,e as l,a as u,i as m,E as v,L as r,l as y,F as q,T as w,Q as b}from"./index-CtYW8DRL.js";import{R as T}from"./vidstack-DWxqfdlP-BceroBD5.js";import{E as $,t as f}from"./vidstack-BTBRWcYx-TSKoe1fv.js";import{resolveVimeoVideoId as I,getVimeoVideoInfo as E}from"./vidstack-BTBUzdbF-Cao5mZMB.js";const P=["bufferend","bufferstart","durationchange","ended","enterpictureinpicture","error","fullscreenchange","leavepictureinpicture","loaded","playProgress","loadProgress","pause","play","playbackratechange","qualitychange","seeked","seeking","timeupdate","volumechange","waiting"];class M extends ${constructor(t,e){super(t),this.b=e,this.$$PROVIDER_TYPE="VIMEO",this.scope=p(),this.Ga=0,this.Ha=new n(0,0),this.Ib=new n(0,0),this.F=null,this.H=null,this.sd=null,this.O=d(""),this.pc=d(!1),this.td=null,this.W=null,this.fh=null,this.Ea=new T(this.cd.bind(this)),this.Xk=null,this.cookies=!1,this.title=!0,this.byline=!0,this.portrait=!0,this.color="00ADEF",this.Mm=!1}get c(){return this.b.delegate.c}get type(){return"vimeo"}get currentSrc(){return this.W}get videoId(){return this.O()}get hash(){return this.td}get isPro(){return this.pc()}preconnect(){k(this.fb())}setup(){super.setup(),l(this.ld.bind(this)),l(this.gh.bind(this)),l(this.hh.bind(this)),this.c("provider-setup",this)}destroy(){this.I(),this.q("destroy")}async play(){const{paused:t}=this.b.$state;return this.F||(this.F=f(()=>{if(this.F=null,t())return"Timed out."}),this.q("play")),this.F.promise}async pause(){const{paused:t}=this.b.$state;return this.H||(this.H=f(()=>{if(this.H=null,!t())return"Timed out."}),this.q("pause")),this.H.promise}setMuted(t){this.q("setMuted",t)}setCurrentTime(t){this.q("seekTo",t),this.c("seeking",t)}setVolume(t){this.q("setVolume",t),this.q("setMuted",u(this.b.$state.muted))}setPlaybackRate(t){this.q("setPlaybackRate",t)}async loadSource(t){if(!m(t.src)){this.W=null,this.td=null,this.O.set("");return}const{videoId:e,hash:s}=I(t.src);this.O.set(e??""),this.td=s??null,this.W=t}ld(){this.I();const t=this.O();if(!t){this.db.set("");return}this.db.set(`${this.fb()}/video/${t}`),this.c("load-start")}gh(){const t=this.O();if(!t)return;const e=v(),s=new AbortController;return this.sd=e,E(t,s).then(i=>{e.resolve(i)}).catch(i=>{e.reject()}),()=>{e.reject(),s.abort()}}hh(){const t=this.pc(),{$state:e,qualities:s}=this.b;if(e.canSetPlaybackRate.set(t),s[r.Nc](!t),t)return y(s,"change",()=>{var h;if(s.auto)return;const i=(h=s.selected)==null?void 0:h.id;i&&this.q("setQuality",i)})}fb(){return"https://player.vimeo.com"}Ue(){const{$iosControls:t}=this.b,{keyDisabled:e}=this.b.$props,{controls:s,playsInline:i}=this.b.$state,h=s()||t();return{title:this.title,byline:this.byline,color:this.color,portrait:this.portrait,controls:h,h:this.hash,keyboard:h&&!e(),transparent:!0,playsinline:i(),dnt:!this.cookies}}cd(){this.q("getCurrentTime")}Fb(t,e){if(this.Mm&&t===0)return;const{realCurrentTime:s,realDuration:i,paused:h,bufferedEnd:a}=this.b.$state;if(s()===t)return;const c=s(),o={currentTime:t,played:this.Ek(t)};this.c("time-update",o,e),Math.abs(c-t)>1.5&&(this.c("seeking",t,e),!h()&&a()<t&&this.c("waiting",void 0,e)),i()-t<.01&&(this.c("end",void 0,e),this.Mm=!0,setTimeout(()=>{this.Mm=!1},500))}Ek(t){return this.Ga>=t?this.Ha:this.Ha=new n(0,this.Ga=t)}cb(t,e){this.c("seeked",t,e)}rd(t){var s;const e=this.O();(s=this.sd)==null||s.promise.then(i=>{if(!i)return;const{title:h,poster:a,duration:c,pro:o}=i;this.pc.set(o),this.c("title-change",h,t),this.c("poster-change",a,t),this.c("duration-change",c,t),this.nd(c,t)}).catch(()=>{e===this.O()&&(this.q("getVideoTitle"),this.q("getDuration"))})}nd(t,e){const{$iosControls:s}=this.b,{controls:i}=this.b.$state,h=i()||s();this.Ib=new n(0,t);const a={buffered:new n(0,0),seekable:this.Ib,duration:t};this.b.delegate.kc(a,e),h||this.q("_hideOverlay"),this.q("getQualities"),this.q("getChapters")}ih(t,e,s){switch(t){case"getVideoTitle":const i=e;this.c("title-change",i,s);break;case"getDuration":const h=e;this.b.$state.canPlay()?this.c("duration-change",h,s):this.nd(h,s);break;case"getCurrentTime":this.Fb(e,s);break;case"getBuffered":q(e)&&e.length&&this.Ze(e[e.length-1][1],s);break;case"setMuted":this.bb(u(this.b.$state.volume),e,s);break;case"getChapters":this.ol(e);break;case"getQualities":this.qc(e,s);break}}jh(){for(const t of P)this.q("addEventListener",t)}Ba(t){var e;this.Ea.sa(),this.c("pause",void 0,t),(e=this.H)==null||e.resolve(),this.H=null}yb(t){var e;this.Ea.Cb(),this.c("play",void 0,t),(e=this.F)==null||e.resolve(),this.F=null}kh(t){const{paused:e}=this.b.$state;e()||this.c("playing",void 0,t)}Ze(t,e){const s={buffered:new n(0,t),seekable:this.Ib};this.c("progress",s,e)}lh(t){this.c("waiting",void 0,t)}mh(t){const{paused:e}=this.b.$state;e()||this.c("playing",void 0,t)}ed(t){const{paused:e}=this.b.$state;e()&&this.c("play",void 0,t),this.c("waiting",void 0,t)}bb(t,e,s){const i={volume:t,muted:e};this.c("volume-change",i,s)}ol(t){if(this.cl(),!t.length)return;const e=new w({kind:"chapters",default:!0}),{realDuration:s}=this.b.$state;for(let i=0;i<t.length;i++){const h=t[i],a=t[i+1];e.addCue(new window.VTTCue(h.startTime,(a==null?void 0:a.startTime)??s(),h.title))}this.Xk=e,this.b.textTracks.add(e)}cl(){this.Xk&&(this.b.textTracks.remove(this.Xk),this.Xk=null)}qc(t,e){this.b.qualities[b._a]=t.some(s=>s.id==="auto")?()=>{this.q("setQuality","auto")}:void 0;for(const s of t){if(s.id==="auto")continue;const i=+s.id.slice(0,-1);isNaN(i)||this.b.qualities[r.pa]({id:s.id,width:i*(16/9),height:i,codec:"avc1,h.264",bitrate:-1},e)}this.gb(t.find(s=>s.active),e)}gb({id:t}={},e){if(!t)return;const s=t==="auto",i=this.b.qualities.toArray().find(h=>h.id===t);s?(this.b.qualities[b.Za](s,e),this.b.qualities[r.qa](void 0,!0,e)):this.b.qualities[r.qa](i,!0,e)}nh(t,e,s){switch(t){case"ready":this.jh();break;case"loaded":this.rd(s);break;case"play":this.yb(s);break;case"playProgress":this.kh(s);break;case"pause":this.Ba(s);break;case"loadProgress":this.Ze(e.seconds,s);break;case"waiting":this.ed(s);break;case"bufferstart":this.lh(s);break;case"bufferend":this.mh(s);break;case"volumechange":this.bb(e.volume,u(this.b.$state.muted),s);break;case"durationchange":this.Ib=new n(0,e.duration),this.c("duration-change",e.duration,s);break;case"playbackratechange":this.c("rate-change",e.playbackRate,s);break;case"qualitychange":this.gb(e,s);break;case"fullscreenchange":this.c("fullscreen-change",e.fullscreen,s);break;case"enterpictureinpicture":this.c("picture-in-picture-change",!0,s);break;case"leavepictureinpicture":this.c("picture-in-picture-change",!1,s);break;case"ended":this.c("end",void 0,s);break;case"error":this.V(e,s);break;case"seek":case"seeked":this.cb(e.seconds,s);break}}V(t,e){var s;if(t.method==="setPlaybackRate"&&this.pc.set(!1),t.method==="play"){(s=this.F)==null||s.reject(t.message);return}}jd(t,e){t.event?this.nh(t.event,t.data,e):t.method&&this.ih(t.method,t.value,e)}mc(){}q(t,e){return this.hd({method:t,value:e})}I(){this.Ea.sa(),this.Ga=0,this.Ha=new n(0,0),this.Ib=new n(0,0),this.F=null,this.H=null,this.sd=null,this.fh=null,this.pc.set(!1),this.cl()}}export{M as VimeoProvider};
